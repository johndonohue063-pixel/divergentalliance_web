import "package:flutter/material.dart";
import "../ui/da_button.dart";
import "../screens/weather_center_gate.dart";

class WeatherCenter extends StatefulWidget {
  static const route = "/weather-center";
  const WeatherCenter({super.key});
  @override
  State<WeatherCenter> createState() => _WeatherCenterState();
}

class _WeatherCenterState extends State<WeatherCenter> {
  // ---------------- WIND-FIRST FILTERS ----------------
  final Map<String, List<String>> regionStates = {
    "Gulf": ["Texas", "Louisiana", "Mississippi", "Alabama", "Florida"],
    "Southeast": [
      "Florida",
      "Georgia",
      "South Carolina",
      "North Carolina",
      "Tennessee",
      "Alabama",
      "Mississippi"
    ],
    "East Coast": [
      "Florida",
      "Georgia",
      "South Carolina",
      "North Carolina",
      "Virginia",
      "Maryland",
      "Delaware",
      "New Jersey",
      "New York",
      "Connecticut",
      "Rhode Island",
      "Massachusetts"
    ],
    "Midwest": [
      "Illinois",
      "Indiana",
      "Ohio",
      "Michigan",
      "Wisconsin",
      "Minnesota",
      "Missouri",
      "Iowa"
    ],
    "West": [
      "California",
      "Oregon",
      "Washington",
      "Nevada",
      "Arizona",
      "Utah",
      "Colorado",
      "New Mexico"
    ],
  };

  String region = "Nationwide"; // scope 1
  String? stateSel; // scope 2 (enabled when region != Nationwide)
  String window = "D0 Today"; // D0..D4 forecast window

  // Wind focus (locked on)
  double probability = 35; // %
  bool crewsEstimate = true;

  @override
  void initState() {
    super.initState();
    // HARD GUARD: require PIN each fresh session
    if (WeatherCenterGate.authorized != true) {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        Navigator.pushReplacementNamed(context, WeatherCenterGate.route);
      });
    }
  }

  // Threat level mapping (wind outages)
  int threatLevel(double p) {
    if (p >= 45) return 3;
    if (p >= 30) return 2;
    if (p >= 20) return 1;
    return 0;
  }

  Color threatColor(int lvl) => switch (lvl) {
        3 => const Color(0xFFB00020), // crimson
        2 => const Color(0xFFFF6A00), // DA orange
        1 => const Color(0xFFFFC107), // amber
        _ => const Color(0xFF64B5F6), // calm
      };

  String threatLabel(int lvl) => switch (lvl) {
        3 => "Level 3",
        2 => "Level 2",
        1 => "Level 1",
        _ => "Level 0",
      };

  // Simple, ops-friendly crew estimator tuned by scope
  // State scale:    L1=10,  L2=30,  L3=60
  // Region scale:   L1=50,  L2=150, L3=300
  // Nationwide:     L1=100, L2=300, L3=600
  int estimateCrews(double p) {
    final lvl = threatLevel(p);
    String scope = "Nationwide";
    if (region != "Nationwide") scope = "Region";
    if (stateSel != null) scope = "State";

    final base = switch (scope) {
      "State" => [0, 10, 30, 60],
      "Region" => [0, 50, 150, 300],
      _ => [0, 100, 300, 600],
    };
    return base[lvl];
  }

  List<String> currentStates() {
    if (region == "Nationwide") return const [];
    return regionStates[region] ?? const [];
  }

  void _run() {
    final lvl = threatLevel(probability);
    final crews = crewsEstimate ? estimateCrews(probability) : 0;
    final scope = stateSel ?? region;
    final msg = "Scope: " +
        (region == "Nationwide" ? "Nationwide" : scope) +
        " • Window: " +
        window +
        " • Wind Prob: " +
        probability.toStringAsFixed(0) +
        "%" +
        " • " +
        threatLabel(lvl) +
        " • Suggested Crews: " +
        crews.toString();
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(msg)));
  }

  @override
  Widget build(BuildContext context) {
    final lvl = threatLevel(probability);
    final states = currentStates();
    final theme = Theme.of(context);

    return Scaffold(
      appBar: AppBar(
        title: const Text("Weather Center"),
        actions: [
          Container(
            margin: const EdgeInsets.symmetric(vertical: 10, horizontal: 12),
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
            decoration: BoxDecoration(
              color: threatColor(lvl).withOpacity(.18),
              border: Border.all(color: threatColor(lvl)),
              borderRadius: BorderRadius.circular(20),
            ),
            child: Row(children: [
              const Icon(Icons.flag_rounded, size: 16),
              const SizedBox(width: 6),
              Text(threatLabel(lvl),
                  style: const TextStyle(fontWeight: FontWeight.w700)),
            ]),
          )
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            // Scope: Nationwide → Region → State
            Row(children: [
              Expanded(
                child: DropdownButtonFormField<String>(
                  value: region,
                  decoration:
                      const InputDecoration(labelText: "Scope / Region"),
                  items: [
                    const DropdownMenuItem(
                        value: "Nationwide", child: Text("Nationwide")),
                    ...regionStates.keys
                        .map((r) => DropdownMenuItem(value: r, child: Text(r))),
                  ],
                  onChanged: (v) {
                    setState(() {
                      region = v ?? "Nationwide";
                      stateSel = null; // reset state on region change
                    });
                  },
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: DropdownButtonFormField<String>(
                  value: stateSel,
                  decoration: const InputDecoration(labelText: "State"),
                  items: states
                      .map((s) => DropdownMenuItem(value: s, child: Text(s)))
                      .toList(),
                  onChanged: (v) => setState(() => stateSel = v),
                  disabledHint: const Text("—"),
                ),
              ),
            ]),

            const SizedBox(height: 8),

            // Forecast window D0..D4
            DropdownButtonFormField<String>(
              value: window,
              decoration: const InputDecoration(labelText: "Forecast Window"),
              items: const [
                DropdownMenuItem(value: "D0 Today", child: Text("D0 Today")),
                DropdownMenuItem(value: "D1 +1 day", child: Text("D1 +1 day")),
                DropdownMenuItem(
                    value: "D2 +2 days", child: Text("D2 +2 days")),
                DropdownMenuItem(
                    value: "D3 +3 days", child: Text("D3 +3 days")),
                DropdownMenuItem(
                    value: "D4 +4 days", child: Text("D4 +4 days")),
              ],
              onChanged: (v) => setState(() => window = v ?? window),
            ),

            const SizedBox(height: 16),

            // Wind-only controls
            Align(
              alignment: Alignment.centerLeft,
              child: Text("Wind Outage Probability: " +
                  probability.toStringAsFixed(0) +
                  "%"),
            ),
            Slider(
              min: 0,
              max: 100,
              divisions: 100,
              value: probability,
              onChanged: (v) => setState(() => probability = v),
            ),

            CheckboxListTile(
              value: crewsEstimate,
              onChanged: (v) =>
                  setState(() => crewsEstimate = v ?? crewsEstimate),
              title: Text(
                "Estimate Crews (wind)",
                style: theme.textTheme.bodyLarge,
              ),
              subtitle: crewsEstimate
                  ? Text("Suggested crews: " +
                      estimateCrews(probability).toString())
                  : const Text("Crew estimator off"),
              controlAffinity: ListTileControlAffinity.leading,
              contentPadding: EdgeInsets.zero,
            ),

            const SizedBox(height: 16),

            SizedBox(
              width: double.infinity,
              child: DAButton(
                label: "Run Forecast",
                icon: Icons.analytics,
                onPressed: _run,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
