import 'package:flutter/material.dart';
import 'package:divergent_alliance/pages/weather_results.dart';
import 'package:divergent_alliance/services/wx_backend_service.dart';

class WeatherCenterPro extends StatefulWidget {
  const WeatherCenterPro({super.key});

  @override
  State<WeatherCenterPro> createState() => _WeatherCenterProState();
}

class _WeatherCenterProState extends State<WeatherCenterPro> {
  String? _selectedState;
  double _hoursOut = 24;

  // Live backend state
  bool _isLoading = false;
  String? _errorMessage;
  double _liveRiskScore = 0.0;

  static const List<String> _usStates = <String>[
    'Alabama',
    'Alaska',
    'Arizona',
    'Arkansas',
    'California',
    'Colorado',
    'Connecticut',
    'Delaware',
    'Florida',
    'Georgia',
    'Hawaii',
    'Idaho',
    'Illinois',
    'Indiana',
    'Iowa',
    'Kansas',
    'Kentucky',
    'Louisiana',
    'Maine',
    'Maryland',
    'Massachusetts',
    'Michigan',
    'Minnesota',
    'Mississippi',
    'Missouri',
    'Montana',
    'Nebraska',
    'Nevada',
    'New Hampshire',
    'New Jersey',
    'New Mexico',
    'New York',
    'North Carolina',
    'North Dakota',
    'Ohio',
    'Oklahoma',
    'Oregon',
    'Pennsylvania',
    'Rhode Island',
    'South Carolina',
    'South Dakota',
    'Tennessee',
    'Texas',
    'Utah',
    'Vermont',
    'Virginia',
    'Washington',
    'West Virginia',
    'Wisconsin',
    'Wyoming',
  ];

  // Simple population bands just to weight the visuals a little.
  static const Set<String> _largeStates = <String>{
    'California',
    'Texas',
    'Florida',
    'New York',
    'Illinois',
    'Pennsylvania',
    'Ohio',
    'Georgia',
    'North Carolina',
    'Michigan',
  };

  static const Set<String> _lowStates = <String>{
    'Wyoming',
    'Vermont',
    'North Dakota',
    'South Dakota',
    'Delaware',
    'Montana',
    'Rhode Island',
    'Alaska',
  };

  // Slightly translucent so the reactor wall shows through.
  static const Color _bgPanel = Color(0xCC15151F); // AA RR GG BB
  static const Color _borderMetal = Color(0xFF272733);
  static const Color _accent = Color(0xFFFF9100);
  static const Color _accentSoft = Color(0xFFFFB74D);
  static const Color _danger = Color(0xFFFF1744);

  @override
  Widget build(BuildContext context) {
    final double baseScore = _computeRiskScore().clamp(0.0, 1.0);
    final double riskScore =
        (_liveRiskScore > 0.0 ? _liveRiskScore : baseScore).clamp(0.0, 1.0);
    final String riskLabel = _riskLabelForScore(riskScore);
    final Color riskColor = _riskColorForScore(riskScore);

    final String customersBand = _customersBandLabel(riskScore);
    final String crewsBand = _crewsBandLabel(riskScore);
    final String pressureLabel = _outagePressureLabel(riskScore);
    final String windowLabel = _windowLabel();
    final String stateLabel = _selectedState ?? 'Select a state';
    final int riskPercent = (riskScore * 100).round();

    // Ticker text: different message depending on selection/loading.
    late final String tickerText;
    if (_selectedState == null) {
      tickerText =
          'Divergent Wx Center • Select a state and adjust hours, then run the state report.';
    } else if (_isLoading) {
      tickerText =
          '$stateLabel • Focusing live weather & outage risk over $windowLabel. '
          'Once state is selected, give the system a moment to focus.';
    } else {
      tickerText =
          'STATE: $stateLabel • Threat: $riskLabel ($riskPercent%) • '
          'Customers band: $customersBand • Crews band: $crewsBand • Window: $windowLabel';
    }

    return Scaffold(
      appBar: AppBar(
        title: const Text('Divergent Alliance Weather Center'),
        backgroundColor: Colors.black,
      ),
      body: Stack(
        children: <Widget>[
          // Reactor wall background
          Positioned.fill(
            child: Image.asset(
              'assets/images/wx_reactor_wall.png',
              fit: BoxFit.cover,
            ),
          ),
          // Semi-transparent overlay so content is readable but wall still shows
          Container(
            color: const Color(0x88000000), // ~53% black
            child: SafeArea(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: <Widget>[
                    _buildBrandPanel(),
                    const SizedBox(height: 12),
                    _buildTickerStrip(text: tickerText),
                    const SizedBox(height: 16),
                    _buildConsolePanel(
                      riskScore: riskScore,
                      riskLabel: riskLabel,
                      riskColor: riskColor,
                      customersBand: customersBand,
                      crewsBand: crewsBand,
                      pressureLabel: pressureLabel,
                      windowLabel: windowLabel,
                      stateLabel: stateLabel,
                    ),
                    const SizedBox(height: 18),
                    _buildLampRow(
                      riskScore: riskScore,
                      customersBand: customersBand,
                      crewsBand: crewsBand,
                      windowLabel: windowLabel,
                    ),
                    const SizedBox(height: 22),
                    _buildRunButton(),
                    const SizedBox(height: 24),
                    const WeatherCenterRadar(),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // BRAND + TICKER -----------------------------------------------------------

  Widget _buildBrandPanel() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
      decoration: BoxDecoration(
        color: const Color(0xCC101015),
        borderRadius: BorderRadius.circular(14),
        border: Border.all(color: _borderMetal, width: 2),
        boxShadow: <BoxShadow>[
          BoxShadow(
            color: _accent.withValues(alpha: 0.7),
            blurRadius: 18,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Row(
        children: <Widget>[
          // Glowing Divergent badge.
          Container(
            width: 36,
            height: 36,
            decoration: BoxDecoration(
              color: Colors.black,
              borderRadius: BorderRadius.circular(10),
              border: Border.all(color: _accent, width: 1.5),
              boxShadow: <BoxShadow>[
                BoxShadow(
                  color: _accent.withValues(alpha: 0.7),
                  blurRadius: 16,
                  spreadRadius: 2,
                ),
              ],
            ),
            child: const Icon(
              Icons.construction,
              color: _accent,
              size: 20,
            ),
          ),
          const SizedBox(width: 10),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: <Widget>[
              Text(
                'DIVERGENT ALLIANCE',
                style: TextStyle(
                  color: _accentSoft,
                  fontSize: 11,
                  letterSpacing: 2.0,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: 2),
              Text(
                'STATE IMPACT MODULE',
                style: TextStyle(
                  color: Colors.white54,
                  fontSize: 10,
                  letterSpacing: 1.4,
                ),
              ),
            ],
          ),
          const Spacer(),
          const Icon(Icons.circle, color: Colors.grey, size: 6),
          const SizedBox(width: 6),
          const Icon(Icons.circle, color: Colors.grey, size: 6),
        ],
      ),
    );
  }

  Widget _buildTickerStrip({required String text}) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
      decoration: BoxDecoration(
        color: const Color(0xCC000000),
        borderRadius: BorderRadius.circular(999),
        border: Border.all(color: _accentSoft, width: 1.2),
      ),
      child: Row(
        children: <Widget>[
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
            decoration: BoxDecoration(
              color: _danger,
              borderRadius: BorderRadius.circular(4),
            ),
            child: const Text(
              'LIVE',
              style: TextStyle(
                color: Colors.white,
                fontSize: 9,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          const SizedBox(width: 8),
          const Icon(Icons.campaign, color: Colors.white, size: 16),
          const SizedBox(width: 8),
          Expanded(
            child: SingleChildScrollView(
              scrollDirection: Axis.horizontal,
              child: Text(
                text,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 11,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // MAIN CONSOLE PANEL -------------------------------------------------------

  Widget _buildConsolePanel({
    required double riskScore,
    required String riskLabel,
    required Color riskColor,
    required String customersBand,
    required String crewsBand,
    required String pressureLabel,
    required String windowLabel,
    required String stateLabel,
  }) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: _bgPanel,
        borderRadius: BorderRadius.circular(22),
        border: Border.all(color: _borderMetal, width: 2),
        boxShadow: const <BoxShadow>[
          BoxShadow(
            color: Colors.black87,
            blurRadius: 22,
            offset: Offset(0, 10),
          ),
        ],
      ),
      child: Column(
        children: <Widget>[
          // Removed the old "State impact radar" row to clean up the label.
          const SizedBox(height: 4),
          Row(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: <Widget>[
              // Left side: controls as physical sliders / selectors.
              Expanded(
                flex: 3,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: <Widget>[
                    const Text(
                      'State',
                      style: TextStyle(
                        color: Colors.white60,
                        fontSize: 11,
                      ),
                    ),
                    const SizedBox(height: 4),
                    _buildStateDropdown(),
                    const SizedBox(height: 8),
                    if (_isLoading)
                      Row(
                        children: const <Widget>[
                          SizedBox(
                            width: 14,
                            height: 14,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              valueColor:
                                  AlwaysStoppedAnimation<Color>(_accent),
                            ),
                          ),
                          SizedBox(width: 6),
                          Expanded(
                            child: Text(
                              'Focusing this state snapshot…',
                              style: TextStyle(
                                color: Colors.white70,
                                fontSize: 10,
                              ),
                            ),
                          ),
                        ],
                      )
                    else if (_errorMessage != null)
                      Text(
                        'Backend issue: $_errorMessage',
                        style: const TextStyle(
                          color: Colors.redAccent,
                          fontSize: 10,
                        ),
                      ),
                    const SizedBox(height: 12),
                    const Text(
                      'Hours out',
                      style: TextStyle(
                        color: Colors.white60,
                        fontSize: 11,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Row(
                      children: <Widget>[
                        Expanded(
                          child: Slider(
                            value: _hoursOut,
                            min: 6,
                            max: 72,
                            divisions: 11,
                            label: '${_hoursOut.round()} h',
                            onChanged: (double value) {
                              setState(() {
                                _hoursOut = value;
                              });
                            },
                          ),
                        ),
                        const SizedBox(width: 8),
                        Text(
                          '${_hoursOut.round()} h',
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 11,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    Row(
                      children: const <Widget>[
                        Icon(Icons.circle, size: 6, color: Colors.grey),
                        SizedBox(width: 4),
                        Expanded(
                          child: Text(
                            'Adjust window, then run the state report for full detail.',
                            style: TextStyle(
                              color: Colors.white38,
                              fontSize: 10,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              const SizedBox(width: 16),
              // Right side: neon threat gauge.
              Expanded(
                flex: 3,
                child: _buildThreatGauge(
                  riskScore: riskScore,
                  riskLabel: riskLabel,
                  riskColor: riskColor,
                  customersBand: customersBand,
                  crewsBand: crewsBand,
                  pressureLabel: pressureLabel,
                  windowLabel: windowLabel,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildStateDropdown() {
    return DropdownButtonFormField<String>(
      decoration: const InputDecoration(
        isDense: true,
        filled: true,
        fillColor: Color(0xFF101018),
        border: OutlineInputBorder(
          borderSide: BorderSide(color: Colors.white24),
          borderRadius: BorderRadius.all(Radius.circular(8)),
        ),
        enabledBorder: OutlineInputBorder(
          borderSide: BorderSide(color: Colors.white24),
          borderRadius: BorderRadius.all(Radius.circular(8)),
        ),
        contentPadding: EdgeInsets.symmetric(horizontal: 10, vertical: 8),
      ),
      dropdownColor: Colors.black,
      style: const TextStyle(color: Colors.white),
      value: _usStates.contains(_selectedState) ? _selectedState : null,
      items: _usStates
          .map(
            (String s) => DropdownMenuItem<String>(
              value: s,
              child: Text(s),
            ),
          )
          .toList(),
      onChanged: (String? value) {
        setState(() {
          _selectedState = value;
        });
        _loadStateSummary();
      },
    );
  }

  Widget _buildThreatGauge({
    required double riskScore,
    required String riskLabel,
    required Color riskColor,
    required String customersBand,
    required String crewsBand,
    required String pressureLabel,
    required String windowLabel,
  }) {
    final double clamped = riskScore.clamp(0.0, 1.0);
    final int percent = (clamped * 100).round();

    return Column(
      crossAxisAlignment: CrossAxisAlignment.center,
      children: <Widget>[
        const SizedBox(height: 4),
        const Text(
          'Overall threat',
          style: TextStyle(
            color: Colors.white70,
            fontSize: 11,
          ),
        ),
        const SizedBox(height: 10),
        TweenAnimationBuilder<double>(
          key: ValueKey<double>(clamped),
          tween: Tween<double>(begin: 0.0, end: clamped),
          duration: const Duration(milliseconds: 600),
          curve: Curves.easeOutCubic,
          builder: (BuildContext context, double value, Widget? child) {
            return Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                gradient: RadialGradient(
                  colors: <Color>[
                    riskColor.withValues(alpha: 0.45),
                    Colors.transparent,
                  ],
                ),
                boxShadow: <BoxShadow>[
                  BoxShadow(
                    color: riskColor.withValues(alpha: 0.7),
                    blurRadius: 26,
                    spreadRadius: 2,
                  ),
                ],
              ),
              child: SizedBox(
                height: 130,
                width: 130,
                child: Stack(
                  alignment: Alignment.center,
                  children: <Widget>[
                    SizedBox(
                      height: 120,
                      width: 120,
                      child: CircularProgressIndicator(
                        value: value,
                        strokeWidth: 8,
                        backgroundColor: const Color(0xFF05070D),
                        valueColor: AlwaysStoppedAnimation<Color>(riskColor),
                      ),
                    ),
                    Column(
                      mainAxisSize: MainAxisSize.min,
                      children: <Widget>[
                        Text(
                          '$percent%',
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          riskLabel,
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 13,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            );
          },
        ),
        const SizedBox(height: 10),
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            _smallGaugeChip(
              icon: Icons.people_alt,
              label: 'Cust',
              value: customersBand,
            ),
            const SizedBox(width: 6),
            _smallGaugeChip(
              icon: Icons.groups,
              label: 'Crews',
              value: crewsBand,
            ),
          ],
        ),
        const SizedBox(height: 6),
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            _smallGaugeChip(
              icon: Icons.power,
              label: 'Pressure',
              value: pressureLabel,
            ),
            const SizedBox(width: 6),
            _smallGaugeChip(
              icon: Icons.schedule,
              label: 'Window',
              value: windowLabel,
            ),
          ],
        ),
      ],
    );
  }

  Widget _smallGaugeChip({
    required IconData icon,
    required String label,
    required String value,
  }) {
    return Expanded(
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),
        decoration: BoxDecoration(
          color: const Color(0xCC181824),
          borderRadius: BorderRadius.circular(999),
          border: Border.all(color: Colors.white12),
        ),
        child: Row(
          children: <Widget>[
            Icon(icon, color: _accentSoft, size: 14),
            const SizedBox(width: 4),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  Text(
                    label,
                    style: const TextStyle(
                      color: Colors.white54,
                      fontSize: 9,
                    ),
                  ),
                  Text(
                    value,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // STATUS LAMP ROW ----------------------------------------------------------

  Widget _buildLampRow({
    required double riskScore,
    required String customersBand,
    required String crewsBand,
    required String windowLabel,
  }) {
    final int percent = (riskScore.clamp(0.0, 1.0) * 100).round();

    return Row(
      children: <Widget>[
        Expanded(
          child: _lampTile(
            icon: Icons.circle_outlined,
            label: 'Outage risk index',
            footer: '$percent% index',
            value: riskScore,
            color: _riskColorForScore(riskScore),
          ),
        ),
        const SizedBox(width: 8),
        Expanded(
          child: _lampTile(
            icon: Icons.people_alt,
            label: 'Customers at risk',
            footer: customersBand,
            value: 0.6,
            color: _accent,
          ),
        ),
        const SizedBox(width: 8),
        Expanded(
          child: _lampTile(
            icon: Icons.groups,
            label: 'Crews needed',
            footer: crewsBand,
            value: 0.6,
            color: _accentSoft,
          ),
        ),
        const SizedBox(width: 8),
        Expanded(
          child: _lampTile(
            icon: Icons.schedule,
            label: 'Impact window',
            footer: windowLabel,
            value: 0.5,
            color: Colors.lightBlueAccent,
          ),
        ),
      ],
    );
  }

  Widget _lampTile({
    required IconData icon,
    required String label,
    required String footer,
    required double value,
    required Color color,
  }) {
    final double v = value.clamp(0.0, 1.0);

    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: _bgPanel,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white10),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: <Widget>[
          Row(
            children: <Widget>[
              Icon(icon, color: _accentSoft, size: 14),
              const SizedBox(width: 4),
              Expanded(
                child: Text(
                  label,
                  style: const TextStyle(
                    color: Colors.white70,
                    fontSize: 10,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 6),
          ClipRRect(
            borderRadius: BorderRadius.circular(999),
            child: Container(
              height: 8,
              decoration: const BoxDecoration(
                color: Colors.black,
              ),
              child: Align(
                alignment: Alignment.centerLeft,
                child: FractionallySizedBox(
                  widthFactor: v,
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: <Color>[
                          color.withValues(alpha: 0.2),
                          color,
                          color.withValues(alpha: 0.8),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ),
          const SizedBox(height: 4),
          Text(
            footer,
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 11,
              fontWeight: FontWeight.w600,
            ),
          ),
        ],
      ),
    );
  }

  // RUN BUTTON ---------------------------------------------------------------

  Widget _buildRunButton() {
    final bool enabled = _selectedState != null;

    return Container(
      decoration: BoxDecoration(
        boxShadow: enabled
            ? <BoxShadow>[
                BoxShadow(
                  color: _accent.withValues(alpha: 0.7),
                  blurRadius: 26,
                  spreadRadius: 1,
                ),
              ]
            : null,
      ),
      child: SizedBox(
        width: double.infinity,
        child: ElevatedButton(
          style: ElevatedButton.styleFrom(
            backgroundColor:
                enabled ? _accent : const Color(0xFF333333),
            padding: const EdgeInsets.symmetric(vertical: 16),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(30),
            ),
          ),
          onPressed: enabled ? _onRunPressed : null,
          child: const Text(
            'Run state report',
            style: TextStyle(
              color: Colors.black,
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
      ),
    );
  }

  void _onRunPressed() {
    if (_selectedState == null) {
      return;
    }

    Navigator.push(
      context,
      MaterialPageRoute<void>(
        builder: (_) => WeatherResults(
          isNational: false,
          state: _selectedState ?? '',
          region: '',
          hoursOut: _hoursOut.toInt(),
        ),
      ),
    );
  }

  // LIVE BACKEND SNAPSHOT ----------------------------------------------------

  Future<void> _loadStateSummary() async {
    final String? s = _selectedState;
    if (s == null) {
      return;
    }

    setState(() {
      _isLoading = true;
      _errorMessage = null;
    });

    try {
      final rows = await WxBackendService.fetchState(
        state: s,
        hours: _hoursOut.toInt(),
        sample: 40,
      );

      if (rows.isEmpty) {
        setState(() {
          _isLoading = false;
          _liveRiskScore = 0.0;
        });
        return;
      }

      final normalized = WxBackendService.normalizeRows(rows);
      double maxProb = 0.0;
      double maxSeverity = 0.0;

      for (final Map<String, dynamic> r in normalized) {
        final double p = (r['probability'] as num?)?.toDouble() ?? 0.0;
        final double sev =
            double.tryParse((r['severity'] ?? '0').toString()) ?? 0.0;
        if (p > maxProb) maxProb = p;
        if (sev > maxSeverity) maxSeverity = sev;
      }

      final double probScore = (maxProb / 100.0).clamp(0.0, 1.0);
      final double sevScore = (maxSeverity / 3.0).clamp(0.0, 1.0);
      final double combined =
          ((probScore * 0.7) + (sevScore * 0.3)).clamp(0.0, 1.0);

      setState(() {
        _isLoading = false;
        _liveRiskScore = combined;
      });
    } catch (e) {
      setState(() {
        _isLoading = false;
        _errorMessage = e.toString();
        _liveRiskScore = 0.0;
      });
    }
  }

  // RISK HELPERS (visual only) ----------------------------------------------

  int _populationBandIndex() {
    final String? s = _selectedState;
    if (s == null) {
      return 1;
    }
    if (_largeStates.contains(s)) {
      return 2;
    }
    if (_lowStates.contains(s)) {
      return 0;
    }
    return 1;
  }

  double _computeRiskScore() {
    final int popBand = _populationBandIndex();
    double base;
    switch (popBand) {
      case 2:
        base = 0.32;
        break;
      case 0:
        base = 0.18;
        break;
      default:
        base = 0.24;
        break;
    }

    final double hoursNorm = (_hoursOut - 6.0) / (72.0 - 6.0);
    final double extra = hoursNorm * 0.40;

    double score = base + extra;
    if (score < 0.08) score = 0.08;
    if (score > 0.95) score = 0.95;
    return score;
  }

  String _riskLabelForScore(double v) {
    if (v < 0.30) return 'Low';
    if (v < 0.50) return 'Elevated';
    if (v < 0.70) return 'High';
    return 'Severe';
  }

  Color _riskColorForScore(double v) {
    if (v < 0.25) {
      return const Color(0xFFFFC400);
    }
    if (v < 0.5) {
      return const Color(0xFFFFD54F);
    }
    if (v < 0.75) {
      return const Color(0xFFFFA000);
    }
    return _danger;
  }

  String _customersBandLabel(double risk) {
    final int popBand = _populationBandIndex();
    final double exposure = risk * (0.8 + popBand * 0.4);
    if (exposure < 0.2) return '< 10k';
    if (exposure < 0.45) return '--';
    if (exposure < 0.7) return '--';
    return '> 200k';
  }

  String _crewsBandLabel(double risk) {
    final double exposure = risk * (1.0 + 0.3 * _populationBandIndex());
    if (exposure < 0.2) return '8–12 crews';
    if (exposure < 0.45) return '12–25 crews';
    if (exposure < 0.7) return '--';
    return '50+ crews';
  }

  String _outagePressureLabel(double risk) {
    if (risk < 0.3) return 'Normal ops';
    if (risk < 0.5) return 'Raised posture';
    if (risk < 0.7) return 'Storm ops ready';
    return 'Full storm posture';
  }

  String _windowLabel() {
    if (_hoursOut <= 12) return '0–12 h';
    if (_hoursOut <= 24) return '--';
    if (_hoursOut <= 48) return '24–48 h';
    return '--';
  }
}

// RADAR PANEL ---------------------------------------------------------------

class WeatherCenterRadar extends StatelessWidget {
  const WeatherCenterRadar({super.key});

  @override
  Widget build(BuildContext context) {
    const String radarUrl =
        'https://radar.weather.gov/ridge/standard/CONUS_loop.gif';

    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: <Widget>[
        const Text(
          'NOAA CONUS radar',
          style: TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 8),
        ClipRRect(
          borderRadius: BorderRadius.circular(10),
          child: Container(
            color: Colors.black,
            height: 230,
            child: InteractiveViewer(
              minScale: 1.0,
              maxScale: 4.0,
              child: Image.network(
                radarUrl,
                fit: BoxFit.cover,
                gaplessPlayback: true,
                loadingBuilder: (
                  BuildContext context,
                  Widget child,
                  ImageChunkEvent? loadingProgress,
                ) {
                  if (loadingProgress == null) {
                    return child;
                  }
                  return const Center(
                    child: CircularProgressIndicator(),
                  );
                },
                errorBuilder: (
                  BuildContext context,
                  Object error,
                  StackTrace? stack,
                ) {
                  return const Center(
                    child: Text(
                      'Radar unavailable',
                      style: TextStyle(color: Colors.red),
                    ),
                  );
                },
              ),
            ),
          ),
        ),
      ],
    );
  }
}
