



import 'package:flutter/material.dart';
import 'package:flutter/services.dart' show rootBundle;
import "../services/nws_client.dart";
import "../services/crew_logic.dart";

class WeatherCenterPro extends StatefulWidget{
  const WeatherCenterPro({super.key});
  @override State<WeatherCenterPro> createState()=>_WeatherCenterProState();
}
class _WeatherCenterProState extends State<WeatherCenterPro>{
  static const Color brandOrange=Color(0xFFFF6A00), glass=Color(0xCC101214);
  // === Filters (restored)
  String _scope = 'Nationwide'; // Nationwide, Region, State
  String _region = 'All';
  String _state = 'All';

  // Points cache from CSV (County, State, lat, lon, Population, Cluster)
  List<Map<String,dynamic>>? _pointsCache;
  final String _pointsCsv = 'assets/ui/national_points.csv';

  bool _loading=true; String? _error; List<Map<String,dynamic>> _rows=[];
  int _dayOffset=0;

  final List<Map<String,dynamic>> _points=const [
    {"County":"Harris","State":"TX","lat":29.7752,"lon":-95.3103,"Population":4700000,"Cluster":"Gulf"},
    {"County":"Cook","State":"IL","lat":41.84,"lon":-87.68,"Population":5100000,"Cluster":"Midwest"},
    {"County":"Duval","State":"FL","lat":30.33,"lon":-81.65,"Population":1000000,"Cluster":"Atlantic"},
    {"County":"Horry","State":"SC","lat":33.92,"lon":-78.98,"Population":380000,"Cluster":"Carolinas"},
    {"County":"Wake","State":"NC","lat":35.78,"lon":-78.64,"Population":1120000,"Cluster":"Carolinas"},
    {"County":"Norfolk","State":"VA","lat":36.85,"lon":-76.29,"Population":240000,"Cluster":"Tidewater"},
  ];

  @override void initState(){super.initState(); _fetch();}

  Future<void> _fetch() async {
    await _loadPoints();
    setState(()=>_loading=true); try{
      final base=await NwsClient.nationalWind(points: _filterPoints(),hours:24,concurrency:6);
      final fixed=base.map((r){
        final s=(r["Max Sustained (mph)"]??0).toDouble();
        final g=(r["Max Gust (mph)"]??0).toDouble();
        final pop=(r["Population"]??0) is int ? r["Population"] : int.tryParse("${r["Population"]}")??0;
        final metrics = CrewLogic.compute(sustainedMph:s,gustMph:g,population:pop);
        return {...r, ...metrics};
      }).toList();
      if(!mounted) return; setState(()=>{_rows=fixed,_loading=false,_error=null});
      // print for sanity
      // ignore: avoid_print
      print("[NWS] rows=${fixed.length}  ex: ${fixed.first}");
    }catch(e){ if(!mounted) return; setState(()=>{_loading=false,_error="NWS fetch failed: $e",_rows=[]}); }
  }

  @override Widget build(BuildContext context){
    return Scaffold(
      backgroundColor:Colors.black,
      appBar:AppBar(backgroundColor:Colors.black,elevation:0,title:const Text("Weather Center"),actions:[
        IconButton(onPressed:_fetch, icon:const Icon(Icons.refresh, color:Colors.white70)),
      ]),
      body: ListView(padding:const EdgeInsets.fromLTRB(12,8,12,16), children:[
        _section("Threshold", _thresholdUI()),
        Widget _filtersSection() {
  return Container(
    padding: const EdgeInsets.all(12),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: <Widget>[
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: const <Widget>[
            Text('Filters', style: TextStyle(color: Colors.white70)),
            SizedBox.shrink(),
          ],
        ),
        const SizedBox(height: 8),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: <Widget>[
            const Text('Days out', style: TextStyle(color: Colors.white70)),
            Text('D'),
          ],
        ),
      ],
    ),
  );
}

Widget _loadingList()=>Column(children:List.generate(5,(_)=>Container(
    height:70,margin:const EdgeInsets.only(bottom:10),
    decoration:BoxDecoration(color:Colors.white.withOpacity(0.06),
      borderRadius:BorderRadius.circular(16),border:Border.all(color:brandOrange.withOpacity(0.35))))));

  Widget _errorPane(String m)=>Column(children:[
    const Icon(Icons.warning_amber_rounded,color:Colors.amber,size:26),
    const SizedBox(height:8), Text(m,textAlign:TextAlign.center,style:const TextStyle(fontWeight:FontWeight.w600)),
    const SizedBox(height:10), TextButton.icon(onPressed:_fetch,icon:const Icon(Icons.refresh),label:const Text("Try again")),
  ]);
  // --- Points loading & filtering (CSV -> points -> filter by scope/region/state) ---
  Future<void> _loadPoints() async {
    if (_pointsCache != null) return;
    final csv = await rootBundle.loadString(_pointsCsv);
    final lines = csv.split('\n').where((l) => l.trim().isNotEmpty).toList();
    if (lines.isEmpty) { _pointsCache = <Map<String,dynamic>>[]; return; }
    final header = lines.first.split(',');
    int iCounty = header.indexOf('County');
    int iState  = header.indexOf('State');
    int iLat    = header.indexOf('lat');
    int iLon    = header.indexOf('lon');
    int iPop    = header.indexOf('Population');
    int iClu    = header.indexOf('Cluster');
    final rows = <Map<String,dynamic>>[];
    for (int i=1;i<lines.length;i++){
      final parts = lines[i].split(',');
      if (parts.length < 4) continue;
      double? lat = double.tryParse(parts[iLat.clamp(0,parts.length-1)]);
      double? lon = double.tryParse(parts[iLon.clamp(0,parts.length-1)]);
      if (lat==null || lon==null) continue;
      rows.add({
        'County'    : parts[iCounty.clamp(0,parts.length-1)].trim(),
        'State'     : parts[iState.clamp(0,parts.length-1)].trim(),
        'lat'       : lat,
        'lon'       : lon,
        'Population': (iPop>=0 && iPop<parts.length) ? int.tryParse(parts[iPop]) ?? 0 : 0,
        'Cluster'   : (iClu>=0 && iClu<parts.length) ? parts[iClu].trim() : '',
      });
    }
    _pointsCache = rows;
  }

  List<Map<String,dynamic>> _filterPoints() {
    final pts = _pointsCache ?? <Map<String,dynamic>>[];
    if (pts.isEmpty) return [];
    if (_scope == 'Nationwide') return pts;
    if (_scope == 'Region') {
      if (_region == 'All') return pts;
      return pts.where((p) => (p['Cluster'] ?? '') == _region).toList();
    }
    // State scope
    if (_state == 'All') return pts;
    return pts.where((p) => (p['State'] ?? '') == _state).toList();
  }

  List<String> _statesForRegion(String region) {
    if (region == 'All' || _pointsCache == null) {
      final all = (_pointsCache ?? []);
      final s = all.map((p) => (p['State'] ?? '').toString()).where((e) => e.isNotEmpty).toSet().toList()..sort();
      return ['All', ...s];
    }
    final r = _pointsCache!.where((p) => (p['Cluster'] ?? '') == region);
    final s = r.map((p) => (p['State'] ?? '').toString()).where((e) => e.isNotEmpty).toSet().toList()..sort();
    return ['All', ...s];
  }

  Widget _filtersSection() {
    return Container(
      margin: const EdgeInsets.symmetric(vertical: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: const Color(0xCC101214),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: const Color(0xFFFF6A00).withOpacity(0.35)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Padding(
            padding: EdgeInsets.fromLTRB(4, 0, 0, 8),
            child: Text('Filters', style: TextStyle(color: Colors.white70, fontWeight: FontWeight.w600)),
          ),
          Row(
            children: [
              // Scope
              Expanded(
                child: DropdownButtonHideUnderline(
                  child: DropdownButton<String>(
                    dropdownColor: Colors.black,
                    value: _scope,
                    items: const [
                      DropdownMenuItem(value: 'Nationwide', child: Text('Nationwide')),
                      DropdownMenuItem(value: 'Region', child: Text('Region')),
                      DropdownMenuItem(value: 'State', child: Text('State')),
                    ],
                    onChanged: (v) async {
                      if (v == null) return;
                      setState(() { _scope = v; if (_scope == 'Nationwide') { _region='All'; _state='All'; } });
                      await _fetch();
                    },
                  ),
                ),
              ),
              const SizedBox(width: 10),
              // Region
              Expanded(
                child: Opacity(
                  opacity: _scope == 'Region' || _scope == 'State' ? 1 : 0.45,
                  child: DropdownButtonHideUnderline(
                    child: DropdownButton<String>(
                      dropdownColor: Colors.black,
                      value: _region,
                      items: const [
                        DropdownMenuItem(value: 'All', child: Text('All Regions')),
                        DropdownMenuItem(value: 'Gulf', child: Text('Gulf')),
                        DropdownMenuItem(value: 'Atlantic', child: Text('Atlantic')),
                        DropdownMenuItem(value: 'Carolinas', child: Text('Carolinas')),
                        DropdownMenuItem(value: 'Tidewater', child: Text('Tidewater')),
                        DropdownMenuItem(value: 'Midwest', child: Text('Midwest')),
                        DropdownMenuItem(value: 'Plains', child: Text('Plains')),
                        DropdownMenuItem(value: 'West', child: Text('West')),
                      ],
                      onChanged: _scope == 'Nationwide' ? null : (v) async {
                        if (v == null) return;
                        setState(() { _region = v; _state = 'All'; });
                        await _fetch();
                      },
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 10),
              // State
              Expanded(
                child: Opacity(
                  opacity: _scope == 'State' ? 1 : 0.45,
                  child: DropdownButtonHideUnderline(
                    child: DropdownButton<String>(
                      dropdownColor: Colors.black,
                      value: _state,
                      items: _statesForRegion(_region).map((s) =>
                        DropdownMenuItem(value: s, child: Text(s))).toList(),
                      onChanged: _scope != 'State' ? null : (v) async {
                        if (v == null) return;
                        setState(() { _state = v; });
                        await _fetch();
                      },
                    ),
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          // Day slider (D0..D4, kept as UI hint; fetch uses hours=24 for now)
    Row(
    mainAxisAlignment: MainAxisAlignment.spaceBetween,
    children: <Widget>[
    const Text('Days out', style: TextStyle(color: Colors.white70)),
    Text('D${_dayOffset.toString()}'),
    ]


