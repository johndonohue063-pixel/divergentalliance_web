import 'package:flutter/material.dart';
import '../ui/da_button.dart';

class WeatherCenter extends StatefulWidget {
  static const route = '/weather-center';
  const WeatherCenter({super.key});
  @override
  State<WeatherCenter> createState() => _WeatherCenterState();
}

class _WeatherCenterState extends State<WeatherCenter> {
  String region = 'Nationwide';
  String stateSel = 'Texas';
  DateTime? startDate;
  DateTime? endDate;

  bool hazWind = true;
  bool hazFlood = false;
  bool hazIce = false;

  double probability = 35; // %
  bool crewsEstimate = true;

  String _fmt(DateTime? d) => d == null
      ? 'Select'
      : '${d.year}-${d.month.toString().padLeft(2, '0')}-${d.day.toString().padLeft(2, '0')}';

  // Simplified Threat Level logic keyed to probability (can be swapped for your calibrated model)
  int threatLevel(double p) {
    if (p >= 45) return 3;
    if (p >= 30) return 2;
    if (p >= 20) return 1;
    return 0;
  }

  Color threatColor(int lvl) => switch (lvl) {
        3 => const Color(0xFFB00020),
        2 => const Color(0xFFFF6A00),
        1 => const Color(0xFFFFC107),
        _ => const Color(0xFF64B5F6)
      };
  String threatLabel(int lvl) => switch (lvl) {
        3 => 'Level 3',
        2 => 'Level 2',
        1 => 'Level 1',
        _ => 'Level 0'
      };

  Future<void> _pickStart() async {
    final now = DateTime.now();
    final dt = await showDatePicker(
        context: context,
        firstDate: DateTime(now.year - 1),
        lastDate: DateTime(now.year + 1),
        initialDate: startDate ?? now);
    if (dt != null) setState(() => startDate = dt);
  }

  Future<void> _pickEnd() async {
    final base = startDate ?? DateTime.now();
    final dt = await showDatePicker(
        context: context,
        firstDate: DateTime(base.year - 1),
        lastDate: DateTime(base.year + 1),
        initialDate: endDate ?? base);
    if (dt != null) setState(() => endDate = dt);
  }

  void _run() {
    final hazards = <String>[
      if (hazWind) 'Wind',
      if (hazFlood) 'Flood',
      if (hazIce) 'Ice',
    ].join(', ');
    final tl = threatLevel(probability);
    final msg = 'Region: ' +
        region +
        ' | State: ' +
        stateSel +
        ' | Dates: ' +
        _fmt(startDate) +
        ' â†’ ' +
        _fmt(endDate) +
        ' | Hazards: ' +
        hazards +
        ' | Prob: ' +
        probability.toStringAsFixed(0) +
        '%' +
        ' | Threat: ' +
        threatLabel(tl) +
        ' | Crews: ' +
        (crewsEstimate ? 'On' : 'Off');
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(msg)));
  }

  @override
  Widget build(BuildContext context) {
    final pad = const EdgeInsets.symmetric(horizontal: 16, vertical: 8);
    final lvl = threatLevel(probability);

    return Scaffold(
      appBar: AppBar(
        title: const Text('Weather Center'),
        actions: [
          Container(
            margin: const EdgeInsets.symmetric(vertical: 10, horizontal: 12),
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
            decoration: BoxDecoration(
              color: threatColor(lvl).withOpacity(.18),
              border: Border.all(color: threatColor(lvl)),
              borderRadius: BorderRadius.circular(20),
            ),
            child: Row(children: [
              const Icon(Icons.warning_amber_rounded, size: 16),
              const SizedBox(width: 6),
              Text(threatLabel(lvl),
                  style: const TextStyle(fontWeight: FontWeight.w700)),
            ]),
          )
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            // Row 1: Region, State
            Row(children: [
              Expanded(
                child: Padding(
                  padding: pad,
                  child: DropdownButtonFormField<String>(
                    initialValue: region,
                    decoration: const InputDecoration(labelText: 'Region'),
                    items: const [
                      DropdownMenuItem(
                          value: 'Nationwide', child: Text('Nationwide')),
                      DropdownMenuItem(
                          value: 'Southeast', child: Text('Southeast')),
                      DropdownMenuItem(value: 'Gulf', child: Text('Gulf')),
                      DropdownMenuItem(
                          value: 'East Coast', child: Text('East Coast')),
                      DropdownMenuItem(
                          value: 'Midwest', child: Text('Midwest')),
                      DropdownMenuItem(value: 'West', child: Text('West')),
                    ],
                    onChanged: (v) => setState(() => region = v ?? region),
                  ),
                ),
              ),
              Expanded(
                child: Padding(
                  padding: pad,
                  child: DropdownButtonFormField<String>(
                    initialValue: stateSel,
                    decoration: const InputDecoration(labelText: 'State'),
                    items: const [
                      DropdownMenuItem(value: 'Texas', child: Text('Texas')),
                      DropdownMenuItem(
                          value: 'Florida', child: Text('Florida')),
                      DropdownMenuItem(
                          value: 'Georgia', child: Text('Georgia')),
                      DropdownMenuItem(
                          value: 'South Carolina',
                          child: Text('South Carolina')),
                      DropdownMenuItem(
                          value: 'North Carolina',
                          child: Text('North Carolina')),
                      DropdownMenuItem(
                          value: 'Virginia', child: Text('Virginia')),
                    ],
                    onChanged: (v) => setState(() => stateSel = v ?? stateSel),
                  ),
                ),
              ),
            ]),

            // Row 2: Date range
            Row(children: [
              Expanded(
                child: Padding(
                  padding: pad,
                  child: InkWell(
                    onTap: _pickStart,
                    child: InputDecorator(
                      decoration:
                          const InputDecoration(labelText: 'Start date'),
                      child: Text(_fmt(startDate)),
                    ),
                  ),
                ),
              ),
              Expanded(
                child: Padding(
                  padding: pad,
                  child: InkWell(
                    onTap: _pickEnd,
                    child: InputDecorator(
                      decoration: const InputDecoration(labelText: 'End date'),
                      child: Text(_fmt(endDate)),
                    ),
                  ),
                ),
              ),
            ]),

            // Row 3: Hazards
            Padding(
              padding: pad,
              child: Align(
                alignment: Alignment.centerLeft,
                child: Wrap(
                  spacing: 12,
                  runSpacing: 8,
                  children: [
                    FilterChip(
                        selected: hazWind,
                        label: const Text('Wind'),
                        onSelected: (s) => setState(() => hazWind = s)),
                    FilterChip(
                        selected: hazFlood,
                        label: const Text('Flood'),
                        onSelected: (s) => setState(() => hazFlood = s)),
                    FilterChip(
                        selected: hazIce,
                        label: const Text('Ice'),
                        onSelected: (s) => setState(() => hazIce = s)),
                  ],
                ),
              ),
            ),

            // Row 4: Probability + crews
            Padding(
              padding: pad,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text('Wind Outage Probability: ' +
                      probability.toStringAsFixed(0) +
                      '%'),
                  Slider(
                      min: 0,
                      max: 100,
                      divisions: 100,
                      value: probability,
                      onChanged: (v) => setState(() => probability = v)),
                  CheckboxListTile(
                    value: crewsEstimate,
                    onChanged: (v) =>
                        setState(() => crewsEstimate = v ?? crewsEstimate),
                    title: const Text('Estimate Crews'),
                    controlAffinity: ListTileControlAffinity.leading,
                    contentPadding: EdgeInsets.zero,
                  ),
                ],
              ),
            ),

            const SizedBox(height: 16),
            SizedBox(
              width: double.infinity,
              child: DAButton(
                  label: 'Run Forecast',
                  icon: Icons.analytics,
                  onPressed: _run),
            ),
          ],
        ),
      ),
    );
  }
}
