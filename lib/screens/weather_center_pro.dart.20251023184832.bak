import 'package:flutter/material.dart';

/// WEATHER CENTER (PRO) â€” simple, readable, drill-down demo
/// â€¢ Shows Region summary, KPI chips, and State â†’ County drill-down
/// â€¢ Uses local demo data so you can see layout immediately
/// â€¢ Keep the class name exactly as-is (WeatherCenterPro) â€” main.dart depends on it

class WeatherCenterPro extends StatefulWidget {
  const WeatherCenterPro({super.key});

  @override
  State<WeatherCenterPro> createState() => _WeatherCenterProState();
}

class _WeatherCenterProState extends State<WeatherCenterPro> {
  // ----- Filters (wired locally for now) -----
  String _region = 'National';
  String? _state;
  int _windMph = 35; // Clamp between 20..120 if you add networking later
  int _daysOut = 2;  // Clamp between 0..10 if you add networking later

  // ----- Demo data so the UI is not blank -----
  // Replace this list with your WxApi results later.
  final List<Map<String, dynamic>> _rows = <Map<String, dynamic>>[
    {'state': 'FL', 'county': 'Duval',     'prob': 52, 'customers': 14000, 'threat': 'Level 3'},
    {'state': 'FL', 'county': 'St. Johns', 'prob': 41, 'customers':  9000, 'threat': 'Level 2'},
    {'state': 'GA', 'county': 'Glynn',     'prob': 31, 'customers':  4500, 'threat': 'Level 1'},
    {'state': 'SC', 'county': 'Beaufort',  'prob': 24, 'customers':  3200, 'threat': 'Level 1'},
    {'state': 'SC', 'county': 'Jasper',    'prob': 18, 'customers':  2800, 'threat': 'Level 0'},
  ];

  @override
  Widget build(BuildContext context) {
    final byState = _groupByState(_rows);
    final totals  = _totals(byState);

    return Scaffold(
      appBar: AppBar(title: const Text('Weather Center (Pro)')),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          _filters(),
          const SizedBox(height: 12),
          _summaryHeader(totals),
          const SizedBox(height: 8),
          // Drill-down: States -> Counties
          for (final s in byState.keys.toList()..sort())
            _stateTile(s, byState[s]!),
        ],
      ),
    );
  }

  // ================== UI PARTS ==================

  Widget _filters() {
    return Wrap(
      spacing: 12,
      runSpacing: 12,
      children: [
        _fieldCard(
          title: 'Region',
          child: DropdownButton<String>(
            value: _region,
            isExpanded: true,
            items: const [
              DropdownMenuItem(value: 'National', child: Text('National')),
              DropdownMenuItem(value: 'East',     child: Text('East')),
              DropdownMenuItem(value: 'Central',  child: Text('Central')),
              DropdownMenuItem(value: 'West',     child: Text('West')),
            ],
            onChanged: (v) => setState(() => _region = v ?? 'National'),
          ),
        ),
        _fieldCard(
          title: 'State (optional)',
          child: TextField(
            controller: TextEditingController(text: _state ?? ''),
            decoration: const InputDecoration(hintText: 'e.g., FL'),
            onSubmitted: (v) => setState(() {
              final t = v.trim().toUpperCase();
              _state = t.isEmpty ? null : t;
            }),
          ),
        ),
        _fieldCard(
          title: 'Wind mph â‰¥',
          child: TextField(
            controller: TextEditingController(text: '$_windMph'),
            keyboardType: TextInputType.number,
            onSubmitted: (v) => setState(() {
              final n = int.tryParse(v) ?? _windMph;
              _windMph = n.clamp(20, 120);
            }),
          ),
        ),
        _fieldCard(
          title: 'Days out',
          child: TextField(
            controller: TextEditingController(text: '$_daysOut'),
            keyboardType: TextInputType.number,
            onSubmitted: (v) => setState(() {
              final n = int.tryParse(v) ?? _daysOut;
              _daysOut = n.clamp(0, 10);
            }),
          ),
        ),
      ],
    );
  }

  Widget _summaryHeader((_Totals)) {
  final (_Totals t) = (_Totals);
  return Wrap(
  spacing: 8,
  runSpacing: 8,
  children: [
  _pill('Region', _region),
  if (_state != null && _state!.isNotEmpty) _pill('State', _state!),
  _pill('Wind â‰¥', '$_windMph mph'),
  _pill('Days',   '$_daysOut'),
  _pill('Top prob', '${t.topProb.toStringAsFixed(0)}%'),
  _pill('Pred. out', _fmtInt(t.totalCustomers)),
  ],
  );
  }

  Widget _stateTile(String state, List<Map<String, dynamic>> counties) {
  final topProb = counties
      .map((r) => (r['prob'] as num?)?.toDouble() ?? 0)
      .fold<double>(0, (p, c) => c > p ? c : p);

  final totalCust = counties
      .map((r) => (r['customers'] as num?)?.round() ?? 0)
      .fold<int>(0, (p, c) => p + c);

  return Card(
  elevation: 1.5,
  margin: const EdgeInsets.only(bottom: 12),
  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
  child: ExpansionTile(
  tilePadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
  title: Row(
  children: [
  _badge(state),
  const SizedBox(width: 12),
  _kpi('% Prob', '${topProb.toStringAsFixed(0)}%'),
  const SizedBox(width: 8),
  _kpi('Cust', _fmtInt(totalCust)),
  ],
  ),
  childrenPadding: const EdgeInsets.fromLTRB(12, 0, 12, 12),
  children: [
  for (final r in counties) _countyTile(r),
  ],
  ),
  );
  }

  Widget _countyTile(Map<String, dynamic> r) {
  final county = (r['county'] ?? 'â€”').toString();
  final threat = (r['threat'] ?? '').toString();
  final prob   = ((r['prob'] as num?)?.toDouble() ?? 0).toStringAsFixed(0);
  final cust   = _fmtInt(((r['customers'] as num?)?.round() ?? 0));

  return ListTile(
  dense: true,
  leading: const Icon(Icons.bolt),
  title: Text(county),
  subtitle: threat.isEmpty ? null : Text(threat),
  trailing: Column(
  mainAxisAlignment: MainAxisAlignment.center,
  crossAxisAlignment: CrossAxisAlignment.end,
  children: [
  Text('$prob%'),
  Text(cust),
  ],
  ),
  );
  }

  // ================== SMALL HELPERS ==================

  Widget _fieldCard({required String title, required Widget child}) {
  final dark = Theme.of(context).brightness == Brightness.dark;
  return Container(
  width: 320,
  padding: const EdgeInsets.all(12),
  decoration: BoxDecoration(
  color: dark ? const Color(0xFF1A1A1D) : Colors.white,
  borderRadius: BorderRadius.circular(14),
  border: Border.all(color: const Color(0xFF2B2B2E)),
  ),
  child: Column(
  crossAxisAlignment: CrossAxisAlignment.start,
  children: [
  Text(title, style: const TextStyle(fontSize: 12, color: Colors.grey)),
  const SizedBox(height: 6),
  child,
  ],
  ),
  );
  }

  Widget _pill(String k, String v) {
  return Container(
  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
  decoration: BoxDecoration(
  color: const Color(0xFFF38B2B).withOpacity(0.15),
  borderRadius: BorderRadius.circular(14),
  border: Border.all(color: const Color(0xFFF38B2B)),
  ),
  child: Row(mainAxisSize: MainAxisSize.min, children: [
  Text('$k: ', style: const TextStyle(fontWeight: FontWeight.w700)),
  Text(v),
  ]),
  );
  }

  Widget _badge(String text) {
  final t = text.isEmpty ? 'â€”' : text;
  return Container(
  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
  decoration: BoxDecoration(color: Colors.black, borderRadius: BorderRadius.circular(8)),
  child: Text(t, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),
  );
  }

  Widget _kpi(String k, String v) {
  return Container(
  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
  decoration: BoxDecoration(
  color: const Color(0xFFF38B2B).withOpacity(0.15),
  borderRadius: BorderRadius.circular(14),
  border: Border.all(color: const Color(0xFFF38B2B)),
  ),
  child: Row(mainAxisSize: MainAxisSize.min, children: [
  Text('$k ', style: const TextStyle(fontWeight: FontWeight.w700)),
  Text(v),
  ]),
  );
  }

  String _fmtInt(num n) {
  final s = n.round().toString();
  final b = StringBuffer();
  for (int i = 0; i < s.length; i++) {
  final rev = s.length - i;
  b.write(s[i]);
  if (rev > 1 && rev % 3 == 1) b.write(',');
  }
  return b.toString();
  }

  Map<String, List<Map<String, dynamic>>> _groupByState(List<Map<String, dynamic>> rows) {
  final m = <String, List<Map<String, dynamic>>>{};
  for (final r in rows) {
  final s = ((r['state'] ?? '') as String).toUpperCase();
  if (s.isEmpty) continue;
  m.putIfAbsent(s, () => <Map<String, dynamic>>[]).add(r);
  }
  return m;
  }

  _Totals _totals(Map<String, List<Map<String, dynamic>>> byState) {
  double top = 0;
  int total = 0;
  for (final entry in byState.entries) {
  for (final r in entry.value) {
  final p = (r['prob'] as num?)?.toDouble() ?? 0;
  final c = (r['customers'] as num?)?.round() ?? 0;
  if (p > top) top = p;
  total += c;
  }
  }
  return _Totals(top, total);
  }
}

// simple container for header totals
class _Totals {
  _Totals(this.topProb, this.totalCustomers);
  final double topProb;
  final int totalCustomers;
}

