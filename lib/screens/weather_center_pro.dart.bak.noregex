import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ),`r`n      GenericSource('HRRR',`r`n              (
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ),`r`n      GenericSource('GFS',`r`n              (
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ),`r`n      GenericSource('NWS',`r`n              (
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n  Widget _filtersCard() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '$
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '$
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('$
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   mph')),`r`n                DataCell(Text('$
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('$
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n      setState(() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n    } finally 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  }`r`n`r`n  void _export() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n  Widget kpiTile(String title, String value, IconData icon) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n  Widget _glassCard(
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n  Widget _pillDropdown<T>(
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  }`r`n`r`n  Widget _threatChip(String name) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   else 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill(
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews(
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    for (final r in rows) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('$
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  : $
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for $
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  '),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   else if (_locationMode == 'Regional') 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const se = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const mw = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const sw = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const pac = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const mtn = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const midAtl = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const gulf = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const lakes = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    const plains = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n`r`n    final m = 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    return _results`r`n        .map((r) => 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  )`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n  num _num(dynamic v) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n}`r`n`r`nclass CountyWxSummary 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n}`r`n`r`nclass _KpiSummary 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function(
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n`r`nclass ForecastSample 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n}`r`n`r`nclass ForecastAggregate 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n}`r`n`r`nclass GeoProfile 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n}`r`n`r`nclass DirectionalRule 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n}`r`n`r`nclass GenericSource implements WxSource 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) async 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n}`r`n`r`nclass WxFusionEngine 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ) async 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   catch (_) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    }`r`n    if (all.isEmpty) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ,`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    for (final r in all) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  );`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ,`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   else if (r is List && r.length >= 3) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  if (v is String) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
   catch (_) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  ;`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand 
    $m = import 'dart:math';`r`nimport 'dart:ui' as ui;`r`nimport 'package:flutter/material.dart';`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport '../services/wx_api.dart' show WxApi;`r`nimport 'package:divergent_alliance/screens/weather_center.dart' as wc;`r`nimport 'package:divergent_alliance/screens/weather_center_gate.dart' as gate;`r`n`r`nimport 'package:divergent_alliance/security/pin_gate.dart';`r`n`r`n/// ================================================================`r`n/// WeatherCenterPro`r`n/// ================================================================`r`n`r`nclass WeatherCenterPro extends StatefulWidget {`r`n  static const route = '/weather-center-pro'; // <-- added route name`r`n  const WeatherCenterPro({super.key});`r`n  @override`r`n  State<WeatherCenterPro> createState() => _WeatherCenterProState();`r`n}`r`n`r`nclass _WeatherCenterProState extends State<WeatherCenterPro> {\n  // Wind range lookup used only inside this screen
  final Map<String, List<int>> _windRangeLut = const {
    'All':      [0, 1000],
    '0-25':     [0, 25],
    '25-50':    [25, 50],
    '50-75':    [50, 75],
    '75-100':   [75, 100],
    '100+':     [100, 1000],
  };\n  String _sustRange = 'All';\n  String _gustRange = 'All';`r`n  int _threatMin = 1;`r`n  int _gustMin = 0;`r`n  int _sustainedMin = 0;`r`n  // BRAND`r`n  static const kBrandOrange = Color(0xFFFF6A00);`r`n  static const kBrandBlack = Color(0xFF0E0E0E);`r`n`r`n  // FILTER STATE`r`n  String _region = 'National'; // legacy, harmless`r`n  String? _state;`r`n  String? _countyFips;`r`n  String _locationMode = 'Nationwide'; // Nationwide, Regional, State`r`n  String? _regionGroup;`r`n`r`n  final Set<String> _threats = {'Wind'}; // OR semantics`r`n`r`n  double _hours = 36; // UI slider goes to 120`r`n  bool _showDetails = true;`r`n`r`n  // DATA`r`n  final List<County> _counties = [];`r`n  final List<CountyWxSummary> _results = [];`r`n  bool _running = false;`r`n`r`n  // SERVICES`r`n  late final WxApi _api;`r`n  late final WxFusionEngine _fusion;`r`n`r`n  @override`r`n  void initState() {`r`n    super.initState();`r`n`r`n    _api = WxApi();`r`n`r`n`r`n    // Real feeds via named-arg callbacks`r`n    _fusion = WxFusionEngine([`r`n      GenericSource('NBM',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nbmTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('HRRR',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.hrrrTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('GFS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.gfsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n      GenericSource('NWS',`r`n              ({required double lat, required double lon, required DateTime start, required DateTime end}) {`r`n            return _api.nwsTimeseries(lat: lat, lon: lon, start: start, end: end);`r`n          }),`r`n    ]);`r`n`r`n    _counties.addAll([`r`n      County(`r`n        fips: '36019',`r`n        name: '',`r`n        state: 'NY',`r`n        population: 79843,`r`n        lat: 44.73,`r`n        lon: -73.68,`r`n        geoProfile: champlainValley,`r`n        dominantDirDeg: 270, // kept for now, fusion still accepts it`r`n        windOutageProbability: 0.16,`r`n      ),`r`n    ]);`r`n  }`r`n`r`n  // =============================== UI ===============================`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Scaffold(`r`n      backgroundColor: kBrandBlack,`r`n      appBar: AppBar(`r`n        backgroundColor: const Color(0xFF121212),`r`n        elevation: 0,`r`n        titleSpacing: 0,`r`n        title: Row(`r`n          children: const [`r`n            SizedBox(width: 8),`r`n            _BrandDot(),`r`n            SizedBox(width: 10),`r`n            Flexible(`r`n              child: Text(`r`n                'Weather Center Pro',`r`n                overflow: TextOverflow.ellipsis,`r`n                softWrap: false,`r`n                style: TextStyle(fontWeight: FontWeight.w700, letterSpacing: 0.3),`r`n              ),`r`n            ),`r`n          ],`r`n        ),`r`n        actions: [`r`n          _cta(Icons.play_arrow_rounded, 'Run Report', _run),`r`n          const SizedBox(width: 8),`r`n          _cta(Icons.download_rounded, 'Export CSV', _export),`r`n          const SizedBox(width: 10),`r`n        ],`r`n      ),`r`n      body: CustomScrollView(`r`n        slivers: [`r`n          SliverPadding(`r`n            padding: const EdgeInsets.all(16),`r`n            sliver: SliverList.list(`r`n              children: [`r`n                _filtersCard(),`r`n                const SizedBox(height: 12),`r`n                _kpiGrid(),`r`n                const SizedBox(height: 12),`r`n                if (_results.isNotEmpty) _crewStrip(_resultsToRows()),`r`n                const SizedBox(height: 12),`r`n                _resultsTable(),`r`n                const SizedBox(height: 20),`r`n              ],`r`n            ),`r`n          ),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _filtersCard() {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Column(`r`n          children: [`r`n            Row(`r`n              children: [`r`n                const Icon(Icons.tune, color: kBrandOrange),`r`n                const SizedBox(width: 8),`r`n                const Text('Filters', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n                const Spacer(),`r`n                Switch(`r`n                  value: _showDetails,`r`n                  onChanged: (v) => setState(() => _showDetails = v),`r`n                  // keep visuals as-is`r`n                  activeColor: kBrandOrange,`r`n                ),`r`n                const SizedBox(width: 6),`r`n                const Text('Show details', style: TextStyle(color: Colors.white70)),`r`n              ],`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Location, Group/State, County`r`n            Wrap(`r`n  spacing: 12,`r`n  runSpacing: 12,`r`n  children: [`r`n    _pillDropdown<String>(`r`n      label: 'Location',`r`n      value: _locationMode,`r`n      items: const <String>['Nationwide', 'Regional', 'State'],`r`n      onChanged: (v) => setState(() {`r`n        _locationMode = v!;`r`n        _regionGroup = null;`r`n        _state = null;`r`n        _countyFips = null; // ensure no hidden pin`r`n      }),`r`n    ),`r`n`r`n    if (_locationMode == 'Regional')`r`n      _pillDropdown<String?>(`r`n        label: 'Region Group',`r`n        value: _regionGroup,`r`n        items: const <String?>[`r`n          null,`r`n          'Northeast','Southeast','Midwest','Southwest','Pacific','Mountain',`r`n          'Mid-Atlantic','Gulf Coast','Great Lakes','Plains',`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _regionGroup = v;`r`n          _state = null;`r`n          _countyFips = null;`r`n        }),`r`n      )`r`n    else if (_locationMode == 'State')`r`n      _pillDropdown<String?>(`r`n        label: 'State',`r`n        value: _state,`r`n        items: const <String?>[`r`n          null,'AL','AK','AZ','AR','CA','CO','CT','DE','DC','FL','GA','HI','IA','ID','IL','IN','KS','KY','LA','MA','MD','ME','MI','MN','MO','MS','MT','NC','ND','NE','NH','NJ','NM','NV','NY','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VA','VT','WA','WI','WV','WY'`r`n        ],`r`n        onChanged: (v) => setState(() {`r`n          _state = v;`r`n          _countyFips = null;`r`n        }),`r`n      ),`r`n`r`n    // --- New filters that were missing ---`r`n    _pillDropdown<int>(`r`n      label: 'Threat =',`r`n      value: _threatMin,`r`n      items: const <int>[0, 1, 2, 3, 4, 5],`r`n      onChanged: (v) => setState(() => _threatMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Gust = (mph)',`r`n      value: _gustMin,`r`n      items: const <int>[0,10,20,30,40,50,60,70,80,90,100,110,120],`r`n      onChanged: (v) => setState(() => _gustMin = v ?? 0),`r`n    ),`r`n    _pillDropdown<int>(`r`n      label: 'Sustained = (mph)',`r`n      value: _sustainedMin,`r`n      items: const <int>[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],`r`n      onChanged: (v) => setState(() => _sustainedMin = v ?? 0),`r`n    ),`r`n`r`n    // County will come back as a friendly "County" selector later.`r`n    // For now we intentionally omit it to avoid pinning to a single FIPS.`r`n  ],`r`n),`r`n            const SizedBox(height: 12),`r`n`r`n            // Threats`r`n            Align(`r`n              alignment: Alignment.centerLeft,`r`n              child: Wrap(`r`n                spacing: 10,`r`n                runSpacing: 10,`r`n                children: [`r`n                  _threatChip('Wind'),`r`n                  _threatChip('Snow & Ice'),`r`n                  _threatChip('Hurricane'),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(height: 12),`r`n`r`n            // Window (to 120h)`r`n            Row(`r`n              children: [`r`n                Expanded(`r`n                  child: _sliderPill(`r`n                    title: 'Window (hours)',`r`n                    value: _hours,`r`n                    min: 12,`r`n                    max: 120,`r`n                    divisions: 36,`r`n                    onChanged: (v) => setState(() => _hours = v),`r`n                  ),`r`n                ),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _kpiGrid() {`r`n    final agg = _aggregateKPIs();`r`n    return LayoutBuilder(`r`n      builder: (ctx, c) {`r`n        final isWide = c.maxWidth >= 900;`r`n        final cross = isWide ? 4 : 2;`r`n        return GridView.count(`r`n          crossAxisCount: cross,`r`n          physics: const NeverScrollableScrollPhysics(),`r`n          shrinkWrap: true,`r`n          crossAxisSpacing: 12,`r`n          mainAxisSpacing: 12,`r`n          childAspectRatio: isWide ? 2.6 : 2.0,`r`n          children: [`r`n            kpiTile('Expected Gust', '${agg.expectedGust.toStringAsFixed(0)} mph', Icons.air_rounded),`r`n            kpiTile('Expected Sust.', '${agg.expectedSustained.toStringAsFixed(0)} mph', Icons.wind_power_rounded),`r`n            kpiTile('Severity', agg.severity, Icons.warning_amber_rounded),`r`n            kpiTile('Crew Rec', '${agg.crews.toStringAsFixed(0)} crews', Icons.groups_rounded),`r`n          ],`r`n        );`r`n      },`r`n    );`r`n  }`r`n`r`n  Widget _resultsTable() {`r`n    if (_results.isEmpty) {`r`n      return _glassCard(`r`n        child: Padding(`r`n          padding: const EdgeInsets.all(16),`r`n          child: Row(`r`n            children: const [`r`n              Icon(Icons.info_outline, color: kBrandOrange),`r`n              SizedBox(width: 10),`r`n              Expanded(`r`n                child: Text(`r`n                  'Run a report to populate county forecasts, severity, and crew guidance.',`r`n                  style: TextStyle(color: Colors.white70),`r`n                ),`r`n              ),`r`n            ],`r`n          ),`r`n        ),`r`n      );`r`n    }`r`n`r`n    return _glassCard(`r`n      child: SingleChildScrollView(`r`n        scrollDirection: Axis.horizontal,`r`n        child: DataTable(`r`n          dividerThickness: 0.6,`r`n          headingTextStyle: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600),`r`n          dataTextStyle: const TextStyle(color: Colors.white),`r`n          columns: const [`r`n            DataColumn(label: Text('County')),`r`n            DataColumn(label: Text('State')),`r`n            DataColumn(label: Text('Expected Gust')),`r`n            DataColumn(label: Text('Expected Sust.')),`r`n            DataColumn(label: Text('Severity')),`r`n            DataColumn(label: Text('Crew Rec')),`r`n          ],`r`n          rows: _results`r`n              .map(`r`n                (r) => DataRow(`r`n              cells: [`r`n                DataCell(Text(r.countyName)),`r`n                DataCell(Text(r.state)),`r`n                DataCell(Text('${r.expectedGust.toStringAsFixed(0)} mph')),`r`n                DataCell(Text('${r.expectedSustained.toStringAsFixed(0)} mph')),`r`n                DataCell(Text(r.severity)),`r`n                DataCell(Text('${r.crews}')),`r`n              ],`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ============================ ACTIONS ===========================`r`n  Future<void> _run() async {`r`n    if (_running) return;`r`n    setState(() => _running = true);`r`n    try {`r`n      final scope = _resolveScope();`r`n      final now = DateTime.now().toUtc();`r`n      final start = now;`r`n      final end = now.add(Duration(hours: _hours.round()));`r`n`r`n      final next = <CountyWxSummary>[];`r`n      for (final c in scope) {`r`n        final agg = await _fusion.fuse(`r`n          lat: c.lat,`r`n          lon: c.lon,`r`n          start: start,`r`n          end: end,`r`n          geo: c.geoProfile ?? const GeoProfile(name: 'Default', rules: []),`r`n          directionDeg: c.dominantDirDeg, // keep for now`r`n        );`r`n`r`n        final severity = classifySeverity(agg.expectedGustMph, agg.expectedSustainedMph);`r`n        final crews = recommendCrews(`r`n          population: c.population,`r`n          probability: c.windOutageProbability,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n        );`r`n`r`n        next.add(CountyWxSummary(`r`n          countyName: c.name,`r`n          state: c.state,`r`n          expectedGust: agg.expectedGustMph,`r`n          expectedSustained: agg.expectedSustainedMph,`r`n          severity: severity,`r`n          crews: crews,`r`n        ));`r`n      }`r`n      setState(() {`r`n        _results`r`n          ..clear()`r`n          ..addAll(next);`r`n      });`r`n    } finally {`r`n      setState(() => _running = false);`r`n    }`r`n  }`r`n`r`n  void _export() {`r`n    if (_results.isEmpty) {`r`n      _snack('Nothing to export, run a report first.');`r`n      return;`r`n    }`r`n    final csv = _resultsToCsv();`r`n    showDialog(`r`n      context: context,`r`n      builder: (ctx) => AlertDialog(`r`n        backgroundColor: const Color(0xFF141414),`r`n        title: const Text('CSV Ready', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w700)),`r`n        content: SingleChildScrollView(child: SelectableText(csv, style: const TextStyle(color: Colors.white70, fontSize: 12))),`r`n        actions: [`r`n          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Close', style: TextStyle(color: kBrandOrange))),`r`n        ],`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ====================== HELPERS (INSIDE CLASS) ======================`r`n  static Widget _cta(IconData icon, String label, VoidCallback onTap) {`r`n    return TextButton.icon(`r`n      onPressed: onTap,`r`n      icon: Icon(icon),`r`n      label: Text(label),`r`n      style: TextButton.styleFrom(`r`n        foregroundColor: kBrandOrange,`r`n        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),`r`n        shape: const StadiumBorder(),`r`n        side: BorderSide(color: kBrandOrange.withOpacity(0.6)),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget kpiTile(String title, String value, IconData icon) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(16),`r`n        child: Row(`r`n          children: [`r`n            Icon(icon, color: kBrandOrange),`r`n            const SizedBox(width: 12),`r`n            Column(`r`n              crossAxisAlignment: CrossAxisAlignment.start,`r`n              children: [`r`n                Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                const SizedBox(height: 6),`r`n                Text(value, style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w700)),`r`n              ],`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  Widget _glassCard({required Widget child}) {`r`n    final r = BorderRadius.circular(16);`r`n    return Container(`r`n      decoration: BoxDecoration(`r`n        gradient: const LinearGradient(colors: [Color(0xFF0A0A0A), Color(0xFF141414)], begin: Alignment.topLeft, end: Alignment.bottomRight),`r`n        borderRadius: r,`r`n        border: Border.all(color: kBrandOrange.withOpacity(0.25), width: 1.0),`r`n        boxShadow: [BoxShadow(color: kBrandOrange.withOpacity(0.15), blurRadius: 24, spreadRadius: 1, offset: const Offset(0, 8))],`r`n      ),`r`n      child: ClipRRect(borderRadius: r, child: BackdropFilter(filter: ui.ImageFilter.blur(sigmaX: 8, sigmaY: 8), child: child)),`r`n    );`r`n  }`r`n`r`n  Widget _pillDropdown<T>({`r`n    required String label,`r`n    required T value,`r`n    required List<T> items,`r`n    required ValueChanged<T?> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),`r`n        child: Row(`r`n          mainAxisSize: MainAxisSize.min,`r`n          children: [`r`n            Text('$label: ', style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n            const SizedBox(width: 6),`r`n            DropdownButton<T>(`r`n              value: value,`r`n              dropdownColor: const Color(0xFF1C1C1C),`r`n              underline: const SizedBox.shrink(),`r`n              iconEnabledColor: kBrandOrange,`r`n              items: items`r`n                  .map((e) => DropdownMenuItem<T>(value: e, child: Text('${e ?? '-'}', style: const TextStyle(color: Colors.white))))`r`n                  .toList(),`r`n              onChanged: onChanged,`r`n            ),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  IconData _threatIcon(String name) {`r`n    switch (name) {`r`n      case 'Wind':`r`n        return Icons.air_rounded;`r`n      case 'Snow & Ice':`r`n        return Icons.ac_unit_rounded;`r`n      case 'Hurricane':`r`n        return Icons.waves;`r`n      default:`r`n        return Icons.warning_amber_rounded;`r`n    }`r`n  }`r`n`r`n  Widget _threatChip(String name) {`r`n    final active = _threats.contains(name);`r`n    return ActionChip(`r`n      avatar: Icon(_threatIcon(name), size: 18, color: kBrandOrange),`r`n      label: Text(name),`r`n      labelStyle: const TextStyle(color: Colors.white),`r`n      backgroundColor: active ? kBrandBlack.withOpacity(0.45) : Colors.black26,`r`n      shape: StadiumBorder(`r`n        side: BorderSide(color: active ? kBrandOrange.withOpacity(0.85) : kBrandOrange.withOpacity(0.35)),`r`n      ),`r`n      onPressed: () => setState(() {`r`n        if (active) {`r`n          _threats.remove(name);`r`n          if (_threats.isEmpty) _threats.add('Wind');`r`n        } else {`r`n          _threats.add(name);`r`n        }`r`n      }),`r`n    );`r`n  }`r`n`r`n  // Slider pill INSIDE the class`r`n  Widget _sliderPill({`r`n    required String title,`r`n    required double value,`r`n    required double min,`r`n    required double max,`r`n    int? divisions,`r`n    required ValueChanged<double> onChanged,`r`n  }) {`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),`r`n        child: Row(`r`n          children: [`r`n            Expanded(`r`n              child: Column(`r`n                crossAxisAlignment: CrossAxisAlignment.start,`r`n                children: [`r`n                  Text(title, style: const TextStyle(color: Colors.white70, fontSize: 12)),`r`n                  Slider(`r`n                    min: min,`r`n                    max: max,`r`n                    value: value,`r`n                    divisions: divisions,`r`n                    onChanged: onChanged,`r`n                    activeColor: kBrandOrange,`r`n                    label: value.toStringAsFixed(0),`r`n                  ),`r`n                ],`r`n              ),`r`n            ),`r`n            const SizedBox(width: 8),`r`n            Text(value.toStringAsFixed(0), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),`r`n            const SizedBox(width: 8),`r`n          ],`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  // ---- Severity ladder + crews (bands stay CONSTANT) -------------`r`n  static const List<_SeverityBand> _bands = <_SeverityBand>[`r`n    _SeverityBand('Level 1', 30, 18),`r`n    _SeverityBand('Level 2', 45, 25),`r`n    _SeverityBand('Level 3', 58, 35),`r`n    _SeverityBand('Level 4', 75, 45),`r`n  ];`r`n`r`n  String classifySeverity(double expectedGust, double expectedSustained) {`r`n    String out = 'Level 0';`r`n    for (final b in _bands) {`r`n      if (expectedGust >= b.minGust || expectedSustained >= b.minSustained) {`r`n        out = b.level;`r`n      }`r`n    }`r`n    return out;`r`n  }`r`n`r`n  int recommendCrews({`r`n    required int population,`r`n    required double probability, // 0..1`r`n    required double expectedGust,`r`n    required double expectedSustained,`r`n  }) {`r`n    final raw = population * probability * 0.002;`r`n    final bump = 1.0 +`r`n        (expectedGust >= 58 ? 0.35 : expectedGust >= 45 ? 0.2 : expectedGust >= 30 ? 0.1 : 0.0) +`r`n        (expectedSustained >= 35 ? 0.2 : expectedSustained >= 25 ? 0.1 : 0.0);`r`n    var crews = (raw * bump).round();`r`n    if (population >= 2000000) crews = (crews * 0.85).round();`r`n    if (population >= 1000000) crews = (crews * 0.90).round();`r`n    return crews.clamp(0, 99999);`r`n  }`r`n`r`n  Widget _crewStrip(List<Map<String, dynamic>> rows) {`r`n    final byRegion = <String, num>{};`r`n    for (final r in rows) {`r`n      final region = (r['Cluster'] ?? r['Region'] ?? 'Region').toString();`r`n      byRegion[region] = (byRegion[region] ?? 0) + _num(r['Suggested Crews']);`r`n    }`r`n    final items = byRegion.entries.toList()..sort((a, b) => b.value.compareTo(a.value));`r`n    return _glassCard(`r`n      child: Padding(`r`n        padding: const EdgeInsets.all(12),`r`n        child: Wrap(`r`n          spacing: 10,`r`n          runSpacing: 8,`r`n          children: items`r`n              .map(`r`n                (e) => ActionChip(`r`n              avatar: const Icon(Icons.groups_rounded, size: 18, color: kBrandOrange),`r`n              label: Text('${e.key}: ${e.value.toStringAsFixed(0)} crews'),`r`n              labelStyle: const TextStyle(color: Colors.white),`r`n              backgroundColor: kBrandBlack.withOpacity(0.35),`r`n              shape: StadiumBorder(side: BorderSide(color: kBrandOrange.withOpacity(0.70), width: 1.2)),`r`n              onPressed: () => _snack('Run regional report for ${e.key}'),`r`n            ),`r`n          )`r`n              .toList(),`r`n        ),`r`n      ),`r`n    );`r`n  }`r`n`r`n  List<County> _resolveScope() {`r`n    return _counties.where((c) {`r`n      if (_locationMode == 'State') {`r`n        if (_state != null && c.state != _state) return false;`r`n      } else if (_locationMode == 'Regional') {`r`n        if (_regionGroup != null && !_isInRegionGroup(c.state, _regionGroup!)) return false;`r`n      }`r`n      if (_countyFips != null && c.fips != _countyFips) return false;`r`n      return true;`r`n    }).toList();`r`n  }`r`n`r`n  bool _isInRegionGroup(String state, String group) {`r`n    const ne = {'ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'};`r`n    const se = {'DE', 'MD', 'DC', 'VA', 'NC', 'SC', 'GA', 'FL', 'AL', 'MS', 'TN', 'KY', 'AR', 'LA'};`r`n    const mw = {'OH', 'MI', 'IN', 'IL', 'WI', 'MN', 'IA', 'MO'};`r`n    const sw = {'AZ', 'NM', 'TX', 'OK'};`r`n    const pac = {'CA', 'OR', 'WA', 'AK', 'HI'};`r`n    const mtn = {'CO', 'UT', 'NV', 'ID', 'MT', 'WY'};`r`n    const midAtl = {'NY', 'NJ', 'PA', 'DE', 'MD', 'DC', 'VA', 'WV'};`r`n    const gulf = {'TX', 'LA', 'MS', 'AL', 'FL'};`r`n    const lakes = {'MN', 'WI', 'IL', 'IN', 'MI', 'OH', 'PA', 'NY'};`r`n    const plains = {'ND', 'SD', 'NE', 'KS', 'OK', 'TX', 'IA', 'MO'};`r`n`r`n    final m = {`r`n      'Northeast': ne,`r`n      'Southeast': se,`r`n      'Midwest': mw,`r`n      'Southwest': sw,`r`n      'Pacific': pac,`r`n      'Mountain': mtn,`r`n      'Mid-Atlantic': midAtl,`r`n      'Gulf Coast': gulf,`r`n      'Great Lakes': lakes,`r`n      'Plains': plains,`r`n    };`r`n    final set = m[group];`r`n    return set == null ? true : set.contains(state);`r`n  }`r`n`r`n  _KpiSummary _aggregateKPIs() {`r`n    if (_results.isEmpty) {`r`n      return const _KpiSummary(expectedGust: 0, expectedSustained: 0, severity: 'Level 0', crews: 0);`r`n    }`r`n    final g = _results.map((e) => e.expectedGust).toList();`r`n    final s = _results.map((e) => e.expectedSustained).toList();`r`n    double avg(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n    final gust = avg(g);`r`n    final sust = avg(s);`r`n    final sev = classifySeverity(gust, sust);`r`n    final crews = _results.map((e) => e.crews).fold<int>(0, (a, b) => a + b);`r`n    return _KpiSummary(expectedGust: gust, expectedSustained: sust, severity: sev, crews: crews.toDouble());`r`n  }`r`n`r`n  List<Map<String, dynamic>> _resultsToRows() {`r`n    String clusterFor(String st) {`r`n      if (['NY', 'VA', 'NC', 'SC', 'GA', 'FL'].contains(st)) return 'East';`r`n      if (['TX'].contains(st)) return 'Central';`r`n      if (['CA'].contains(st)) return 'West';`r`n      return 'National';`r`n    }`r`n    return _results`r`n        .map((r) => {`r`n      'Cluster': clusterFor(r.state),`r`n      'Region': clusterFor(r.state),`r`n      'County': r.countyName,`r`n      'State': r.state,`r`n      'Expected Gust': r.expectedGust,`r`n      'Expected Sustained': r.expectedSustained,`r`n      'Severity': r.severity,`r`n      'Suggested Crews': r.crews,`r`n    })`r`n        .toList();`r`n  }`r`n`r`n  String _resultsToCsv() {`r`n    final rows = _resultsToRows();`r`n    if (rows.isEmpty) return '';`r`n    final headers = rows.first.keys.toList();`r`n    final sb = StringBuffer()..writeln(headers.join(','));`r`n    for (final r in rows) {`r`n      sb.writeln(headers.map((h) => '${r[h]}').join(','));`r`n    }`r`n    return sb.toString();`r`n  }`r`n`r`n  void _snack(String msg) {`r`n    ScaffoldMessenger.of(context).showSnackBar(SnackBar(`r`n      content: Text(msg),`r`n      behavior: SnackBarBehavior.floating,`r`n      backgroundColor: const Color(0xFF1E1E1E),`r`n    ));`r`n  }`r`n`r`n  num _num(dynamic v) {`r`n    if (v is num) return v;`r`n    if (v is String) {`r`n      final s = v.replaceAll(RegExp(r'[^0-9.\-]'), '');`r`n      return num.tryParse(s) ?? 0;`r`n    }`r`n    return 0;`r`n  }`r`n}`r`n`r`n// ============================ MODELS =============================`r`nclass County {`r`n  final String fips;`r`n  final String name;`r`n  final String state;`r`n  final int population;`r`n  final double lat;`r`n  final double lon;`r`n  final GeoProfile? geoProfile;`r`n  final double windOutageProbability; // 0..1`r`n  double dominantDirDeg;`r`n  County({`r`n    required this.fips,`r`n    required this.name,`r`n    required this.state,`r`n    required this.population,`r`n    required this.lat,`r`n    required this.lon,`r`n    this.geoProfile,`r`n    required this.windOutageProbability,`r`n    required this.dominantDirDeg,`r`n  });`r`n}`r`n`r`nclass CountyWxSummary {`r`n  final String countyName;`r`n  final String state;`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final int crews;`r`n  CountyWxSummary({`r`n    required this.countyName,`r`n    required this.state,`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`nclass _KpiSummary {`r`n  final double expectedGust;`r`n  final double expectedSustained;`r`n  final String severity;`r`n  final double crews;`r`n  const _KpiSummary({`r`n    required this.expectedGust,`r`n    required this.expectedSustained,`r`n    required this.severity,`r`n    required this.crews,`r`n  });`r`n}`r`n`r`n// ===================== FUSION + GEO EFFECTS ======================`r`ntypedef WxTimeseriesFetcher = Future<List<dynamic>> Function({`r`nrequired double lat,`r`nrequired double lon,`r`nrequired DateTime start,`r`nrequired DateTime end,`r`n});`r`n`r`nclass ForecastSample {`r`n  final DateTime ts;`r`n  final double sustainedMph;`r`n  final double gustMph;`r`n  final String source;`r`n  final double? dirDeg;`r`n  ForecastSample(this.ts, this.sustainedMph, this.gustMph, this.source, {this.dirDeg});`r`n}`r`n`r`nclass ForecastAggregate {`r`n  final DateTime windowStart;`r`n  final DateTime windowEnd;`r`n  final double avgSustainedMph;`r`n  final double avgGustMph;`r`n  final double expectedSustainedMph;`r`n  final double expectedGustMph;`r`n  final Map<String, double> sourceWeights;`r`n  ForecastAggregate({`r`n    required this.windowStart,`r`n    required this.windowEnd,`r`n    required this.avgSustainedMph,`r`n    required this.avgGustMph,`r`n    required this.expectedSustainedMph,`r`n    required this.expectedGustMph,`r`n    required this.sourceWeights,`r`n  });`r`n}`r`n`r`nclass GeoProfile {`r`n  final String name;`r`n  final List<DirectionalRule> rules;`r`n  const GeoProfile({required this.name, required this.rules});`r`n}`r`n`r`nclass DirectionalRule {`r`n  final double fromDeg;`r`n  final double toDeg;`r`n  final double multiplier;`r`n  const DirectionalRule(this.fromDeg, this.toDeg, this.multiplier);`r`n  bool matches(double deg) =>`r`n      fromDeg <= toDeg ? (deg >= fromDeg && deg <= toDeg) : (deg >= fromDeg || deg <= toDeg);`r`n}`r`n`r`nconst champlainValley =`r`nGeoProfile(name: 'Champlain Valley', rules: [DirectionalRule(260, 320, 0.80)]);`r`n`r`nabstract class WxSource {`r`n  String get name;`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  });`r`n}`r`n`r`nclass GenericSource implements WxSource {`r`n  GenericSource(this.name, this.fetcher);`r`n  @override`r`n  final String name;`r`n  final WxTimeseriesFetcher fetcher;`r`n`r`n  @override`r`n  Future<List<ForecastSample>> fetch({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n  }) async {`r`n    final rows = await fetcher(lat: lat, lon: lon, start: start, end: end);`r`n    return _mapRowsToSamples(rows, name);`r`n  }`r`n}`r`n`r`nclass WxFusionEngine {`r`n  final List<WxSource> sources;`r`n  WxFusionEngine(this.sources);`r`n`r`n  Future<ForecastAggregate> fuse({`r`n    required double lat,`r`n    required double lon,`r`n    required DateTime start,`r`n    required DateTime end,`r`n    required GeoProfile geo,`r`n    required double directionDeg,`r`n  }) async {`r`n    final all = <ForecastSample>[];`r`n    for (final s in sources) {`r`n      try {`r`n        all.addAll(await s.fetch(lat: lat, lon: lon, start: start, end: end));`r`n      } catch (_) {}`r`n    }`r`n    if (all.isEmpty) {`r`n      return ForecastAggregate(`r`n        windowStart: start,`r`n        windowEnd: end,`r`n        avgSustainedMph: 0,`r`n        avgGustMph: 0,`r`n        expectedSustainedMph: 0,`r`n        expectedGustMph: 0,`r`n        sourceWeights: const {},`r`n      );`r`n    }`r`n`r`n    final bySource = <String, List<ForecastSample>>{};`r`n    for (final r in all) {`r`n      bySource.putIfAbsent(r.source, () => []).add(r);`r`n    }`r`n`r`n    final sustainedVals = <double>[];`r`n    final gustVals = <double>[];`r`n    bySource.forEach((_, list) {`r`n      final sAvg = list.map((e) => e.sustainedMph).reduce((a, b) => a + b) / list.length;`r`n      final gAvg = list.map((e) => e.gustMph).reduce((a, b) => a + b) / list.length;`r`n      sustainedVals.add(sAvg);`r`n      gustVals.add(gAvg);`r`n    });`r`n`r`n    double mean(List<double> xs) => xs.reduce((a, b) => a + b) / max(1, xs.length);`r`n`r`n    double trimmedMean(List<double> xs) {`r`n      if (xs.length <= 2) return mean(xs);`r`n      final sorted = [...xs]..sort();`r`n      final trim = max(1, (sorted.length * 0.15).floor());`r`n      final middle = sorted.sublist(trim, sorted.length - trim);`r`n      return mean(middle);`r`n    }`r`n`r`n    var expectedS = trimmedMean(sustainedVals);`r`n    var expectedG = trimmedMean(gustVals);`r`n`r`n    double geoMult = 1.0;`r`n    for (final r in geo.rules) {`r`n      if (r.matches(directionDeg)) geoMult *= r.multiplier;`r`n    }`r`n    geoMult = geoMult.clamp(0.5, 1.25);`r`n`r`n    expectedS *= geoMult;`r`n    expectedG *= geoMult;`r`n`r`n    return ForecastAggregate(`r`n      windowStart: start,`r`n      windowEnd: end,`r`n      avgSustainedMph: mean(sustainedVals),`r`n      avgGustMph: mean(gustVals),`r`n      expectedSustainedMph: expectedS,`r`n      expectedGustMph: expectedG,`r`n      sourceWeights: {for (final k in bySource.keys) k: 1.0},`r`n    );`r`n  }`r`n}`r`n`r`n// ============== universal mapping helpers for adapters ===============`r`nList<ForecastSample> _mapRowsToSamples(List<dynamic> rows, String source) {`r`n  final out = <ForecastSample>[];`r`n  for (final r in rows) {`r`n    if (r is Map<String, dynamic>) {`r`n      final ts = _parseTs(r);`r`n      if (ts == null) continue;`r`n      final sustained =`r`n          _pickDouble(r, ['sustained', 'windSustained', 'wind_speed', 'windSpeed']) ??`r`n              _mphFromString(r['windSpeed']) ??`r`n              0.0;`r`n      final gust =`r`n          _pickDouble(r, ['gust', 'windGust', 'wind_gust']) ??`r`n              _mphFromString(r['windGust']) ??`r`n              max(sustained, 0.0);`r`n      final dir =`r`n          _pickDouble(r, ['dir', 'windDir', 'wind_direction']) ??`r`n              _degFromCardinal(r['windDirection']);`r`n      out.add(ForecastSample(ts, sustained.toDouble(), gust.toDouble(), source, dirDeg: dir));`r`n    } else if (r is List && r.length >= 3) {`r`n      final ts = _parseFlexibleTs(r[0]);`r`n      if (ts == null) continue;`r`n      final sustained = _asDouble(r[1]) ?? 0.0;`r`n      final gust = _asDouble(r[2]) ?? sustained;`r`n      final dir = r.length > 3 ? _asDouble(r[3]) : null;`r`n      out.add(ForecastSample(ts, sustained, gust, source, dirDeg: dir));`r`n    }`r`n  }`r`n  return out;`r`n}`r`n`r`nDateTime? _parseTs(Map<String, dynamic> m) {`r`n  for (final k in ['ts', 'time', 'timestamp', 'validTime', 'startTime', 'valid_time']) {`r`n    final d = _parseFlexibleTs(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`nDateTime? _parseFlexibleTs(dynamic v) {`r`n  if (v is DateTime) return v.toUtc();`r`n  if (v is int) {`r`n    return DateTime.fromMillisecondsSinceEpoch(v > 2000000000 ? v : v * 1000, isUtc: true);`r`n  }`r`n  if (v is String) {`r`n    try {`r`n      return DateTime.parse(v).toUtc();`r`n    } catch (_) {}`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _pickDouble(Map<String, dynamic> m, List<String> keys) {`r`n  for (final k in keys) {`r`n    final d = _asDouble(m[k]);`r`n    if (d != null) return d;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _asDouble(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final n = double.tryParse(v.trim());`r`n    if (n != null) return n;`r`n    final match = RegExp(r'(-?\d+(\.\d+)?)').firstMatch(v);`r`n    if (match != null) return double.tryParse(match.group(1)!);`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _mphFromString(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    final all = RegExp(r'(-?\d+(\.\d+)?)').allMatches(v);`r`n    if (all.isEmpty) return null;`r`n    final nums = all.map((m) => double.parse(m.group(1)!)).toList();`r`n    return nums.length > 1 ? nums.reduce(max) : nums.first;`r`n  }`r`n  return null;`r`n}`r`n`r`ndouble? _degFromCardinal(dynamic v) {`r`n  if (v == null) return null;`r`n  if (v is num) return v.toDouble();`r`n  if (v is String) {`r`n    const map = {`r`n      'N': 0,`r`n      'NNE': 22.5,`r`n      'NE': 45,`r`n      'ENE': 67.5,`r`n      'E': 90,`r`n      'ESE': 112.5,`r`n      'SE': 135,`r`n      'SSE': 157.5,`r`n      'S': 180,`r`n      'SSW': 202.5,`r`n      'SW': 225,`r`n      'WSW': 247.5,`r`n      'W': 270,`r`n      'WNW': 292.5,`r`n      'NW': 315,`r`n      'NNW': 337.5`r`n    };`r`n    final k = v.toUpperCase().replaceAll(RegExp(r'[^A-Z]'), '');`r`n    if (map.containsKey(k)) return map[k]!.toDouble();`r`n  }`r`n  return null;`r`n}`r`n`r`n// ========================== BRAND DOT ============================`r`nclass _BrandDot extends StatelessWidget {`r`n  const _BrandDot();`r`n`r`n  @override`r`n  Widget build(BuildContext context) {`r`n    return Container(`r`n      width: 10,`r`n      height: 10,`r`n      decoration: const BoxDecoration(`r`n        color: _WeatherCenterProState.kBrandOrange,`r`n        shape: BoxShape.circle,`r`n      ),`r`n    );`r`n  }`r`n}`r`n`r`n// === Severity band type must be OUTSIDE any class in Dart =========`r`nclass _SeverityBand {`r`n  final String level;`r`n  final double minGust;`r`n  final double minSustained;`r`n  const _SeverityBand(this.level, this.minGust, this.minSustained);`r`n}`r`n.Groups[1].Value
    if ($m -notmatch "gustMin" -and $m -notmatch "sustainedMin") {
      return ($m -replace "\}$", ", " +
        "`"gustMin`": _windRangeLut[_gustRange]?[0], " +
        "`"gustMax`": _windRangeLut[_gustRange]?[1], " +
        "`"sustainedMin`": _windRangeLut[_sustRange]?[0], " +
        "`"sustainedMax`": _windRangeLut[_sustRange]?[1] }")
    } else { return $m }
  `r`n